<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time IoT Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .sensor-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .weather-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .data-table {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-normal { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-danger { background-color: #ef4444; }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-full">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Real-time IoT Monitoring Dashboard
            </h1>
            <p class="text-gray-300">Dashboard for Sensor and Weather Data Tracking</p>
            <div class="text-sm text-gray-400 mt-2">
                Last Update: <span id="lastUpdate" class="text-green-400"></span>
            </div>
        </div>

        <div class="grid grid-cols-6 gap-6 mb-8">
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üî•</div>
                <h3 class="text-lg font-semibold mb-2">Fire Detection</h3>
                <div class="text-2xl font-bold mb-2" id="fireStatus">Normal</div>
                <div class="status-indicator status-normal pulse" id="fireIndicator"></div>
                <span class="text-sm">Status</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üå°Ô∏è</div>
                <h3 class="text-lg font-semibold mb-2">Temperature</h3>
                <div class="text-2xl font-bold mb-2" id="temperature">25¬∞C</div>
                <div class="status-indicator status-normal" id="tempIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üíß</div>
                <h3 class="text-lg font-semibold mb-2">Humidity</h3>
                <div class="text-2xl font-bold mb-2" id="humidity">65%</div>
                <div class="status-indicator status-normal" id="humidityIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>
            
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üö®</div> 
                <h3 class="text-lg font-semibold mb-2">Gas Sensor Value</h3>
                <div class="text-2xl font-bold mb-2" id="gasValue">0</div>
                <div class="status-indicator status-normal" id="gasIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>
            
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üö™</div>
                <h3 class="text-lg font-semibold mb-2">Door Knock</h3>
                <div class="text-2xl font-bold mb-2" id="doorKnock">None</div>
                <div class="status-indicator status-normal" id="doorIndicator"></div>
                <span class="text-sm">Status</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üé§</div>
                <h3 class="text-lg font-semibold mb-2">Mic Sound</h3>
                <div class="text-2xl font-bold mb-2" id="micLevel">45 dB</div>
                <div class="status-indicator status-normal" id="micIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåç</div>
                    <h3 class="text-xl font-semibold">Earthquake</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Magnitude:</span>
                        <span id="earthquakeMagnitude" class="font-bold">2.1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Distance:</span>
                        <span id="earthquakeDistance">45 km</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="earthquakeStatus" class="text-green-300">Safe</span>
                    </div>
                </div>
            </div>

            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåä</div>
                    <h3 class="text-xl font-semibold">Flood Risk (Rain)</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Rain Accumulation:</span>
                        <span id="floodLevel" class="font-bold">1.2 mm</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Trend:</span>
                        <span id="floodTrend">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="floodStatus" class="text-green-300">Normal</span>
                    </div>
                </div>
            </div>

            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">‚õàÔ∏è</div>
                    <h3 class="text-xl font-semibold">Storm / Wind</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Wind Speed:</span>
                        <span id="windSpeed" class="font-bold">15 km/h</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Direction:</span>
                        <span id="windDirection">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="stormStatus" class="text-green-300">Normal</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-table rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Data Log Table</h3>
                <div class="flex space-x-2">
                    <button onclick="exportData()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        üìä Export Data
                    </button>
                    <button onclick="refreshData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-white bg-opacity-20 text-white">
                            <th class="px-4 py-3 text-left">Time</th>
                            <th class="px-4 py-3 text-left">Temp (¬∞C)</th>
                            <th class="px-4 py-3 text-left">Humidity (%)</th>
                            <th class="px-4 py-3 text-left">Gas</th>
                            <th class="px-4 py-3 text-left">Sound (dB)</th>
                            <th class="px-4 py-3 text-left">Fire</th>
                            <th class="px-4 py-3 text-left">Door</th>
                            <th class="px-4 py-3 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-white">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex justify-between items-center text-sm text-white">
                <span>Showing <span id="recordCount">0</span> records</span>
                <div class="flex space-x-2">
                    <button onclick="prevPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">Previous</button>
                    <span class="px-3 py-1">Page <span id="currentPage">1</span></span>
                    <button onclick="nextPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let sensorData = []; 
        let currentPage = 1;
        const recordsPerPage = 10;
        
        // --- MQTT SETTINGS (WebSockets) ---
        const MQTT_HOST = 'broker.hivemq.com';
        const MQTT_PORT = 8083; // Standard Port for WebSockets
        const API_DATA_TOPIC = "iot/website/api_data"; // From thai_weather_alert.py
        const SENSOR_DATA_TOPIC = "iot/website/sensor_data"; // From SensorBox.txt (All Sensor Data in JSON)

        let mqttClient = null;

        // --- 2. MQTT CORE FUNCTIONS ---
        function connectMQTT() {
            mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "WebClient_" + parseInt(Math.random() * 10000));
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure
            };
            mqttClient.connect(options);
            console.log("Attempting MQTT connection to Dashboard...");
        }

        function onConnect() {
            console.log("MQTT Connected. Subscribing to data topics...");
            mqttClient.subscribe(API_DATA_TOPIC); // For Earthquake, Storm, Flood Risk
            mqttClient.subscribe(SENSOR_DATA_TOPIC); // For Temp, Humidity, Fire, Gas, Mic, Door Knock
        }

        function onFailure(message) {
            console.log("MQTT Connection Failed: " + message.errorMessage);
            setTimeout(connectMQTT, 5000); 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                setTimeout(connectMQTT, 5000);
            }
        }

        // --- 3. DATA PROCESSING: RECEIVES DATA ---
        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                console.log(`Received Data on ${message.destinationName}:`, data);

                if (message.destinationName === API_DATA_TOPIC) {
                    updateWeatherDashboard(data);
                } else if (message.destinationName === SENSOR_DATA_TOPIC) {
                    updateSensorDashboard(data); 
                }
            } catch (e) {
                console.error("Error parsing MQTT data:", e);
            }
        }

        // --- 4. DASHBOARD UPDATE FUNCTIONS ---
        function updateWeatherDashboard(data) {
            // 1. Earthquake
            document.getElementById('earthquakeMagnitude').textContent = data.earthquakeMagnitude || 'N/A';
            document.getElementById('earthquakeDistance').textContent = data.earthquakeDistance || 'N/A';
            
            const eqStatus = data.earthquakeStatus === '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢' ? 'Danger' : 'Safe';
            document.getElementById('earthquakeStatus').textContent = eqStatus;
            document.getElementById('earthquakeStatus').className = eqStatus === 'Danger' ? 'text-red-500' : 'text-green-300';


            // 2. Flood (using rain data structure)
            document.getElementById('floodLevel').textContent = data.floodLevel || 'N/A'; 
            document.getElementById('floodTrend').textContent = data.floodTrend || 'N/A';
            
            const floodStatus = data.floodStatus === '‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' ? 'Warning' : 'Normal';
            document.getElementById('floodStatus').textContent = floodStatus;
            document.getElementById('floodStatus').className = floodStatus === 'Warning' ? 'text-red-500' : 'text-green-300';
            
            // 3. Storm
            document.getElementById('windSpeed').textContent = data.windSpeed || 'N/A';
            document.getElementById('windDirection').textContent = data.windDirection || 'N/A';
            
            const stormStatus = data.stormStatus === 'Warning' ? 'Warning' : 'Normal';
            document.getElementById('stormStatus').textContent = stormStatus;
            document.getElementById('stormStatus').className = stormStatus === 'Warning' ? 'text-red-500' : 'text-green-300';

            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-US');
        }

        // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: FUNCTION TO UPDATE ALL SENSOR DATA FROM MQTT ***
        function updateSensorDashboard(data) {
            // 1. Temperature & Humidity (DHT22)
            const tempValue = parseFloat(data.temp.replace('¬∞C', ''));
            const humidValue = parseFloat(data.humidity.replace('%', ''));
            
            document.getElementById('temperature').textContent = data.temp || 'N/A';
            document.getElementById('humidity').textContent = data.humidity || 'N/A';
            
            // 2. Fire Detection
            const isFire = data.fire === "true" || data.fire === "Detected!"; 
            document.getElementById('fireStatus').textContent = isFire ? 'Detected!' : 'Normal';
            
            // 3. Gas Sensor
            const gasValue = parseFloat(data.gasValue || 0); 
            const isGasAlert = gasValue > 500; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Threshold
            document.getElementById('gasValue').textContent = gasValue.toFixed(0);
            document.getElementById('gasIndicator').className = 'status-indicator ' + (isGasAlert ? 'status-danger pulse' : 'status-normal');
            document.getElementById('gasIndicator').nextElementSibling.textContent = isGasAlert ? 'Alert' : 'Normal'; // Update status text
            
            // 4. Door Knock
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á: "true"/"1" ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏≤‡∏∞, "false"/"0" ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
            const isKnocked = data.doorKnock === "true" || data.doorKnock === "1"; 
            document.getElementById('doorKnock').textContent = isKnocked ? 'Detected' : 'None';
            document.getElementById('doorIndicator').className = 'status-indicator ' + (isKnocked ? 'status-warning' : 'status-normal');

            // 5. Mic Sound
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç dB ‡∏´‡∏£‡∏∑‡∏≠ "XX dB"
            const micLevelText = data.micLevel || 'N/A';
            const micLevelValue = parseFloat(micLevelText.replace(' dB', ''));
            const isMicAlert = micLevelValue > 70; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Threshold
            document.getElementById('micLevel').textContent = micLevelText;
            document.getElementById('micIndicator').className = 'status-indicator ' + (isMicAlert ? 'status-warning' : 'status-normal');


            // 6. Status Indicators 
            document.getElementById('fireIndicator').className = 'status-indicator ' + (isFire ? 'status-danger pulse' : 'status-normal pulse');
            document.getElementById('tempIndicator').className = 'status-indicator ' + (tempValue > 35 ? 'status-danger' : 'status-normal');
            document.getElementById('humidityIndicator').className = 'status-indicator ' + (humidValue > 80 ? 'status-warning' : 'status-normal');
            
            // Update timestamp (for sensor data)
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-US');

            logSensorDataToTable(); 
        }
        
        // ----------------------------------------------------
        // --- 5. SENSOR SIMULATION AND TABLE FUNCTIONS (Modified) ---
        // ----------------------------------------------------

        // *** ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô simulateRealTimeData() ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MQTT ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ***

        // --- MODIFIED: Log the latest REAL sensor data to the table ---
        function logSensorDataToTable() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Element ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const temp = document.getElementById('temperature').textContent.replace('¬∞C', '');
            const humid = document.getElementById('humidity').textContent.replace('%', '');
            const gas = document.getElementById('gasValue').textContent;
            const fire = document.getElementById('fireStatus').textContent;
            
            // Use current data on screen
            const newData = {
                timestamp: new Date().toLocaleString('en-US'),
                temperature: temp,
                humidity: humid,
                gas: gas,
                sound: document.getElementById('micLevel').textContent.replace(' dB', ''),
                fire: fire,
                door: document.getElementById('doorKnock').textContent,
                status: (fire === 'Detected!' || parseFloat(temp) > 35 || parseFloat(gas) > 500) ? 'Alert' : 'Normal'
            };
            
            sensorData.unshift(newData);
            if (sensorData.length > 100) sensorData.pop(); 
            
            updateTable();
        }
        
        // (updateTable, initializeData, nextPage, prevPage, refreshData, exportData functions remain the same)
        function initializeData() {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á
            sensorData = []; 
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            for (let i = 0; i < 50; i++) {
                const date = new Date();
                date.setMinutes(date.getMinutes() - i * 5);
                
                sensorData.push({
                    timestamp: date.toLocaleString('en-US'),
                    temperature: (20 + Math.random() * 15).toFixed(1),
                    humidity: (40 + Math.random() * 40).toFixed(0),
                    gas: (50 + Math.random() * 500).toFixed(0),
                    sound: (30 + Math.random() * 40).toFixed(0),
                    fire: Math.random() > 0.9 ? 'Detected' : 'Normal',
                    door: Math.random() > 0.8 ? 'Knocked' : 'None',
                    status: Math.random() > 0.1 ? 'Normal' : 'Alert'
                });
            }
            updateTable();
        }
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const pageData = sensorData.slice(start, end);
            tbody.innerHTML = '';
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white border-opacity-20 hover:bg-white hover:bg-opacity-10';
                tr.innerHTML = `
                    <td class="px-4 py-3">${row.timestamp}</td>
                    <td class="px-4 py-3">${row.temperature}</td>
                    <td class="px-4 py-3">${row.humidity}</td>
                    <td class="px-4 py-3">${row.gas}</td>
                    <td class="px-4 py-3">${row.sound}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${row.fire === 'Normal' ? 'bg-green-500' : 'bg-red-500'}">${row.fire}</span>
                    </td>
                    <td class="px-4 py-3">${row.door}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${row.status === 'Normal' ? 'bg-green-500' : 'bg-yellow-500'}">${row.status}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('recordCount').textContent = sensorData.length;
            document.getElementById('currentPage').textContent = currentPage;
        }
        function nextPage() {
            const maxPage = Math.ceil(sensorData.length / recordsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                updateTable();
            }
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }
        function refreshData() {
            // Refresh button now triggers a log update
            logSensorDataToTable();
        }
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Time,Temperature,Humidity,Gas,Sound,Fire,Door,Status\n"
                + sensorData.map(row => 
                    `${row.timestamp},${row.temperature},${row.humidity},${row.gas},${row.sound},${row.fire},${row.door},${row.status}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sensor_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- 6. INITIALIZATION ---
        initializeData();
        // Starts the MQTT connection to receive API data and Sensor data
        connectMQTT();
        
    </script>
</body>
</html>
