<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time IoT Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .sensor-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .weather-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .data-table {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-normal { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-danger { background-color: #ef4444; }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-full">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Real-time IoT Monitoring Dashboard
            </h1>
            <p class="text-gray-300">Dashboard for Sensor and Weather Data Tracking</p>
            <div class="text-sm text-gray-400 mt-2">
                Last Update: <span id="lastUpdate" class="text-green-400"></span>
            </div>
        </div>

        <div class="grid grid-cols-5 gap-6 mb-8">
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üî•</div>
                <h3 class="text-lg font-semibold mb-2">Fire Detection</h3>
                <div class="text-2xl font-bold mb-2" id="fireStatus">Normal</div>
                <div class="status-indicator status-normal pulse" id="fireIndicator"></div>
                <span class="text-sm">Status</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üå°Ô∏è</div>
                <h3 class="text-lg font-semibold mb-2">Temperature</h3>
                <div class="text-2xl font-bold mb-2" id="temperature">25¬∞C</div>
                <div class="status-indicator status-normal" id="tempIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üíß</div>
                <h3 class="text-lg font-semibold mb-2">Humidity</h3>
                <div class="text-2xl font-bold mb-2" id="humidity">65%</div>
                <div class="status-indicator status-normal" id="humidityIndicator"></div>
                <span class="text-sm">Normal</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üö™</div>
                <h3 class="text-lg font-semibold mb-2">Door Knock</h3>
                <div class="text-2xl font-bold mb-2" id="doorKnock">None</div>
                <div class="status-indicator status-normal" id="doorIndicator"></div>
                <span class="text-sm">Status</span>
            </div>

            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üé§</div>
                <h3 class="text-lg font-semibold mb-2" id="micCardTitle">Gas Sensor Value</h3> <div class="text-2xl font-bold mb-2" id="micLevel">0</div> 
                <div class="status-indicator status-normal" id="micIndicator"></div>
                <span class="text-sm" id="micCardStatus">Normal</span>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåç</div>
                    <h3 class="text-xl font-semibold">Earthquake</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Magnitude:</span>
                        <span id="earthquakeMagnitude" class="font-bold">2.1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Distance:</span>
                        <span id="earthquakeDistance">45 km</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="earthquakeStatus" class="text-green-300">Safe</span>
                    </div>
                </div>
            </div>

            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåä</div>
                    <h3 class="text-xl font-semibold">Flood Risk (Rain)</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Rain Accumulation:</span>
                        <span id="floodLevel" class="font-bold">1.2 mm</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Trend:</span>
                        <span id="floodTrend">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="floodStatus" class="text-green-300">Normal</span>
                    </div>
                </div>
            </div>

            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">‚õàÔ∏è</div>
                    <h3 class="text-xl font-semibold">Storm / Wind</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Wind Speed:</span>
                        <span id="windSpeed" class="font-bold">15 km/h</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Direction:</span>
                        <span id="windDirection">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="stormStatus" class="text-green-300">Normal</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-table rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Data Log Table</h3>
                <div class="flex space-x-2">
                    <button onclick="exportData()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        üìä Export Data
                    </button>
                    <button onclick="refreshData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-white bg-opacity-20 text-white">
                            <th class="px-4 py-3 text-left">Time</th>
                            <th class="px-4 py-3 text-left">Temp (¬∞C)</th>
                            <th class="px-4 py-3 text-left">Humidity (%)</th>
                            <th class="px-4 py-3 text-left">Gas / Sound Value</th> <th class="px-4 py-3 text-left">Fire</th>
                            <th class="px-4 py-3 text-left">Door Knock</th>
                            <th class="px-4 py-3 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-white">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex justify-between items-center text-sm text-white">
                <span>Showing <span id="recordCount">0</span> records</span>
                <div class="flex space-x-2">
                    <button onclick="prevPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">Previous</button>
                    <span class="px-3 py-1">Page <span id="currentPage">1</span></span>
                    <button onclick="nextPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES & STATE ---
        let sensorData = []; 
        let currentPage = 1;
        const recordsPerPage = 10;
        
        // --- State to hold the latest full data from two devices ---
        let latestSensorBoxData = { temperature: '25¬∞C', humidity: '65%', fireDetected: "false", gasValue: "0" };
        let latestDoorKnockData = { doorKnock: "false", micLevel: "0" };

        // --- MQTT SETTINGS (WebSockets) ---
        const MQTT_HOST = 'broker.hivemq.com';
        const MQTT_PORT = 8083; // Standard Port for WebSockets
        const API_DATA_TOPIC = "iot/website/api_data"; // For weather API data
        const SENSOR_DATA_TOPIC = "iot/website/sensor_data"; // For ALL sensor data

        let mqttClient = null;

        // --- 2. MQTT CORE FUNCTIONS ---
        function connectMQTT() {
            mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "WebClient_" + parseInt(Math.random() * 10000));
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure
            };
            mqttClient.connect(options);
            console.log("Attempting MQTT connection to Dashboard...");
        }

        function onConnect() {
            console.log("MQTT Connected. Subscribing to data topics...");
            mqttClient.subscribe(API_DATA_TOPIC); 
            mqttClient.subscribe(SENSOR_DATA_TOPIC); 
        }

        function onFailure(message) {
            console.log("MQTT Connection Failed: " + message.errorMessage);
            setTimeout(connectMQTT, 5000); 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                setTimeout(connectMQTT, 5000);
            }
        }

        // --- 3. DATA PROCESSING: RECEIVES DATA ---
        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                console.log(`Received Data on ${message.destinationName}:`, data);

                if (message.destinationName === API_DATA_TOPIC) {
                    updateWeatherDashboard(data);
                } else if (message.destinationName === SENSOR_DATA_TOPIC) {
                    updateSensorDashboard(data); 
                }
            } catch (e) {
                console.error("Error parsing MQTT data:", e);
            }
        }

        // --- 4. DASHBOARD UPDATE ---
        function updateWeatherDashboard(data) {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î Weather Card ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
            document.getElementById('earthquakeMagnitude').textContent = data.earthquakeMagnitude;
            document.getElementById('earthquakeDistance').textContent = data.earthquakeDistance;
            
            const eqStatus = data.earthquakeStatus === '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢' ? 'Danger' : 'Safe';
            document.getElementById('earthquakeStatus').textContent = eqStatus;
            document.getElementById('earthquakeStatus').className = eqStatus === 'Danger' ? 'text-red-500' : 'text-green-300';

            document.getElementById('floodLevel').textContent = data.floodLevel; 
            document.getElementById('floodTrend').textContent = data.floodTrend || 'N/A';
            
            const floodStatus = data.floodStatus === '‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' ? 'Warning' : 'Normal';
            document.getElementById('floodStatus').textContent = floodStatus;
            document.getElementById('floodStatus').className = floodStatus === 'Warning' ? 'text-red-500' : 'text-green-300';
            
            document.getElementById('windSpeed').textContent = data.windSpeed;
            document.getElementById('windDirection').textContent = data.windDirection || 'N/A';
            
            const stormStatus = data.stormStatus === 'Warning' ? 'Warning' : 'Normal';
            document.getElementById('stormStatus').textContent = stormStatus;
            document.getElementById('stormStatus').className = stormStatus === 'Warning' ? 'text-red-500' : 'text-green-300';

            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-US');
        }

        // --- üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: FUNCTION TO UPDATE SENSOR DATA FROM MQTT ---
        function updateSensorDashboard(data) {
            // 1. Update the correct state based on which device sent data
            
            // Check for SensorBox data fields
            if (data.temperature) {
                latestSensorBoxData = data;
                document.getElementById('micCardTitle').textContent = 'Gas Sensor Value';
                document.getElementById('micCardStatus').textContent = 'Gas Level';
            }
            // Check for DoorKnock data fields
            if (data.doorKnock) {
                latestDoorKnockData = data;
                
                // If DoorKnock data is newer, change Gas/Mic Card to show Mic Level
                if (parseInt(data.micLevel) > 0) {
                     document.getElementById('micCardTitle').textContent = 'Mic Sound Level';
                     document.getElementById('micCardStatus').textContent = 'Sound';
                }
            }

            // 2. Update all Cards with the LATEST known data
            
            // Temp & Humidity
            document.getElementById('temperature').textContent = latestSensorBoxData.temperature;
            document.getElementById('humidity').textContent = latestSensorBoxData.humidity;
            
            // Fire Detection
            const isFire = latestSensorBoxData.fireDetected === "true";
            document.getElementById('fireStatus').textContent = isFire ? 'Detected!' : 'Normal';
            document.getElementById('fireIndicator').className = isFire ? 'status-indicator status-danger pulse' : 'status-indicator status-normal pulse';

            // Door Knock
            const isKnock = latestDoorKnockData.doorKnock === "true";
            document.getElementById('doorKnock').textContent = isKnock ? 'Detected' : 'None';
            document.getElementById('doorIndicator').className = isKnock ? 'status-indicator status-warning pulse' : 'status-indicator status-normal';

            // Gas / Mic Level (‡πÉ‡∏ä‡πâ Gas ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Mic Level)
            const gasValue = parseInt(latestSensorBoxData.gasValue);
            const micValue = parseInt(latestDoorKnockData.micLevel);
            const gasThreshold = 1000;
            const soundThreshold = 50; // Threshold ‡∏à‡∏≤‡∏Å DoorKnockSensor.ino [cite: 80]

            let displayedValue = gasValue;
            let isAlert = false;
            
            if (micValue > soundThreshold) {
                // ‡πÅ‡∏™‡∏î‡∏á Mic Value ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á
                displayedValue = micValue;
                isAlert = true;
                document.getElementById('micCardTitle').textContent = 'Loud Sound Level';
                document.getElementById('micCardStatus').textContent = 'Loud';
            } else if (gasValue > gasThreshold) {
                // ‡πÅ‡∏™‡∏î‡∏á Gas Value ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Å‡πä‡∏™‡∏£‡∏±‡πà‡∏ß
                isAlert = true;
            }

            document.getElementById('micLevel').textContent = displayedValue;
            document.getElementById('micIndicator').className = isAlert ? 'status-indicator status-danger pulse' : 'status-indicator status-normal';
            if (!isAlert) {
                document.getElementById('micCardTitle').textContent = 'Gas Sensor Value';
                document.getElementById('micCardStatus').textContent = 'Normal';
            }

            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-US');

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            logSensorDataToTable();
        }
        
        // --- 5. TABLE FUNCTIONS ---
        
        // --- Log the combined latest REAL sensor data to the table ---
        function logSensorDataToTable() {
            const temp = latestSensorBoxData.temperature.replace('¬∞C', '');
            const humid = latestSensorBoxData.humidity.replace('%', '');
            const fire = latestSensorBoxData.fireDetected === "true" ? 'Detected!' : 'Normal';
            const gasValue = latestSensorBoxData.gasValue;
            const micValue = latestDoorKnockData.micLevel;
            const door = latestDoorKnockData.doorKnock === "true" ? 'Knocked' : 'None';

            const gasThreshold = 1000;
            const soundThreshold = 50;

            // Determine if the 'Sound' column should show Gas or Mic
            const soundColumnValue = (parseInt(micValue) > soundThreshold) ? 'Mic:' + micValue : 'Gas:' + gasValue;
            
            const isHighTemp = parseFloat(temp) > 35; //
            const isGasLeak = parseInt(gasValue) > gasThreshold; //
            const isLoudSound = parseInt(micValue) > soundThreshold;
            
            // Overall Alert Status
            const status = (fire === 'Detected!' || isHighTemp || isGasLeak || isLoudSound) ? 'Alert' : 'Normal';

            const newData = {
                timestamp: new Date().toLocaleString('en-US'),
                temperature: temp,
                humidity: humid,
                sound: soundColumnValue, // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ Gas/Mic
                fire: fire,
                door: door,
                status: status
            };
            
            sensorData.unshift(newData);
            if (sensorData.length > 100) sensorData.pop(); 
            
            updateTable();
        }
        
        // --- Initial simulation function is now empty as data is REAL-TIME ---
        function simulateRealTimeData() {
             // NO OP: Data comes from MQTT every 2 seconds.
        }
        
        // (functions for initializeData, updateTable, nextPage, prevPage, refreshData, exportData remain as standard)
        function initializeData() {
             // Pre-populate table with default data
            for (let i = 0; i < 50; i++) {
                const date = new Date();
                date.setMinutes(date.getMinutes() - i * 5);
                
                sensorData.push({
                    timestamp: date.toLocaleString('en-US'),
                    temperature: (20 + Math.random() * 15).toFixed(1),
                    humidity: (40 + Math.random() * 40).toFixed(0),
                    sound: 'Gas:' + (100 + Math.random() * 1500).toFixed(0), 
                    fire: Math.random() > 0.9 ? 'Detected' : 'Normal',
                    door: Math.random() > 0.8 ? 'Knocked' : 'None',
                    status: Math.random() > 0.1 ? 'Normal' : 'Alert'
                });
            }
            updateTable();
        }
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const pageData = sensorData.slice(start, end);
            tbody.innerHTML = '';
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white border-opacity-20 hover:bg-white hover:bg-opacity-10';
                tr.innerHTML = `
                    <td class="px-4 py-3">${row.timestamp}</td>
                    <td class="px-4 py-3">${row.temperature}</td>
                    <td class="px-4 py-3">${row.humidity}</td>
                    <td class="px-4 py-3">${row.sound}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${row.fire === 'Normal' ? 'bg-green-500' : 'bg-red-500'}">${row.fire}</span>
                    </td>
                    <td class="px-4 py-3">${row.door}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${row.status === 'Normal' ? 'bg-green-500' : 'bg-yellow-500'}">${row.status}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('recordCount').textContent = sensorData.length;
            document.getElementById('currentPage').textContent = currentPage;
        }
        function nextPage() {
            const maxPage = Math.ceil(sensorData.length / recordsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                updateTable();
            }
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }
        function refreshData() {
            // Force log update with current latest data
            logSensorDataToTable();
        }
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Time,Temperature,Humidity,GasValue/Sound,Fire,Door,Status\n"
                + sensorData.map(row => 
                    `${row.timestamp},${row.temperature},${row.humidity},${row.sound},${row.fire},${row.door},${row.status}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sensor_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 6. INITIALIZATION ---
        initializeData();
        // Starts the MQTT connection to receive ALL data
        connectMQTT();
        
        // Keep the main loop running every 2 seconds to ensure prompt updates even if only one sensor publishes
        setInterval(logSensorDataToTable, 2000); 
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9918fde2534f8940',t:'MTc2MDk2ODMwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
