<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .sensor-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .weather-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .data-table {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-normal { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-danger { background-color: #ef4444; }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-full">
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
            </h1>
            <p class="text-gray-300">Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
            <div class="text-sm text-gray-400 mt-2">
                ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate" class="text-green-400"></span>
            </div>
        </div>

        <!-- Sensor Data Section -->
        <div class="grid grid-cols-5 gap-6 mb-8">
            <!-- Fire Detection -->
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üî•</div>
                <h3 class="text-lg font-semibold mb-2">‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ</h3>
                <div class="text-2xl font-bold mb-2" id="fireStatus">‡∏õ‡∏Å‡∏ï‡∏¥</div>
                <div class="status-indicator status-normal pulse" id="fireIndicator"></div>
                <span class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            </div>

            <!-- Temperature -->
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üå°Ô∏è</div>
                <h3 class="text-lg font-semibold mb-2">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h3>
                <div class="text-2xl font-bold mb-2" id="temperature">25¬∞C</div>
                <div class="status-indicator status-normal" id="tempIndicator"></div>
                <span class="text-sm">‡∏õ‡∏Å‡∏ï‡∏¥</span>
            </div>

            <!-- Humidity -->
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üíß</div>
                <h3 class="text-lg font-semibold mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</h3>
                <div class="text-2xl font-bold mb-2" id="humidity">65%</div>
                <div class="status-indicator status-normal" id="humidityIndicator"></div>
                <span class="text-sm">‡∏õ‡∏Å‡∏ï‡∏¥</span>
            </div>

            <!-- Door Knock -->
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üö™</div>
                <h3 class="text-lg font-semibold mb-2">‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ï‡∏π</h3>
                <div class="text-2xl font-bold mb-2" id="doorKnock">‡πÑ‡∏°‡πà‡∏°‡∏µ</div>
                <div class="status-indicator status-normal" id="doorIndicator"></div>
                <span class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            </div>

            <!-- Microphone -->
            <div class="sensor-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-3">üé§</div>
                <h3 class="text-lg font-semibold mb-2">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡∏Ñ‡πå</h3>
                <div class="text-2xl font-bold mb-2" id="micLevel">45 dB</div>
                <div class="status-indicator status-normal" id="micIndicator"></div>
                <span class="text-sm">‡∏õ‡∏Å‡∏ï‡∏¥</span>
            </div>
        </div>

        <!-- Weather Data Section -->
        <div class="grid grid-cols-3 gap-6 mb-8">
            <!-- Earthquake -->
            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåç</div>
                    <h3 class="text-xl font-semibold">‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>‡∏Ç‡∏ô‡∏≤‡∏î:</span>
                        <span id="earthquakeMagnitude" class="font-bold">2.1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á:</span>
                        <span id="earthquakeDistance">45 ‡∏Å‡∏°.</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span id="earthquakeStatus" class="text-green-300">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
                    </div>
                </div>
            </div>

            <!-- Flood -->
            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üåä</div>
                    <h3 class="text-xl font-semibold">‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥:</span>
                        <span id="floodLevel" class="font-bold">1.2 ‡∏°.</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°:</span>
                        <span id="floodTrend">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span id="floodStatus" class="text-green-300">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    </div>
                </div>
            </div>

            <!-- Storm -->
            <div class="weather-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">‚õàÔ∏è</div>
                    <h3 class="text-xl font-semibold">‡∏û‡∏≤‡∏¢‡∏∏</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°:</span>
                        <span id="windSpeed" class="font-bold">15 ‡∏Å‡∏°./‡∏ä‡∏°.</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á:</span>
                        <span id="windDirection">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span id="stormStatus" class="text-green-300">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="data-table rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="flex space-x-2">
                    <button onclick="exportData()" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button onclick="refreshData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-white bg-opacity-20 text-white">
                            <th class="px-4 py-3 text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="px-4 py-3 text-left">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</th>
                            <th class="px-4 py-3 text-left">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</th>
                            <th class="px-4 py-3 text-left">‡πÄ‡∏™‡∏µ‡∏¢‡∏á (dB)</th>
                            <th class="px-4 py-3 text-left">‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ</th>
                            <th class="px-4 py-3 text-left">‡∏õ‡∏£‡∏∞‡∏ï‡∏π</th>
                            <th class="px-4 py-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-white">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex justify-between items-center text-sm text-white">
                <span>‡πÅ‡∏™‡∏î‡∏á <span id="recordCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <div class="flex space-x-2">
                    <button onclick="prevPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                    <span class="px-3 py-1">‡∏´‡∏ô‡πâ‡∏≤ <span id="currentPage">1</span></span>
                    <button onclick="nextPage()" class="px-3 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        // Sample data for historical purposes (will be overwritten by MQTT real-time data)
        let sensorData = []; 
        let currentPage = 1;
        const recordsPerPage = 10;
        
        // --- MQTT SETTINGS ---
        const MQTT_HOST = 'broker.hivemq.com';
        const MQTT_PORT = 8083; // Use 8083 for WebSockets
        const API_DATA_TOPIC = "iot/website/api_data";

        let mqttClient = null;

        // --- 2. MQTT CORE FUNCTIONS ---
        function connectMQTT() {
            // Using a random client ID to avoid conflicts
            mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "WebClient_" + parseInt(Math.random() * 10000));

            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure
            };

            mqttClient.connect(options);
            console.log("Attempting MQTT connection to API data...");
        }

        function onConnect() {
            console.log("MQTT Connected. Subscribing to API data...");
            mqttClient.subscribe(API_DATA_TOPIC);
        }

        function onFailure(message) {
            console.log("MQTT Connection Failed: " + message.errorMessage);
            setTimeout(connectMQTT, 5000); // Try reconnecting
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                setTimeout(connectMQTT, 5000);
            }
        }

        // --- 3. DATA PROCESSING ---
        function onMessageArrived(message) {
            if (message.destinationName === API_DATA_TOPIC) {
                try {
                    const data = JSON.parse(message.payloadString);
                    console.log("Received API Data:", data);
                    
                    updateWeatherDashboard(data);
                    
                } catch (e) {
                    console.error("Error parsing API data:", e);
                }
            }
            // Add a check for sensor data topic here if SensorBox is also updated
        }

        // --- 4. DASHBOARD UPDATE ---
        function updateWeatherDashboard(data) {
            // 1. Earthquake
            document.getElementById('earthquakeMagnitude').textContent = data.earthquakeMagnitude;
            document.getElementById('earthquakeDistance').textContent = data.earthquakeDistance;
            document.getElementById('earthquakeStatus').textContent = data.earthquakeStatus;

            // 2. Flood (using rain data structure)
            document.getElementById('floodLevel').textContent = data.floodLevel; 
            document.getElementById('floodTrend').textContent = data.floodTrend;
            document.getElementById('floodStatus').textContent = data.floodStatus;
            
            // 3. Storm
            document.getElementById('windSpeed').textContent = data.windSpeed;
            document.getElementById('windDirection').textContent = data.windDirection;
            document.getElementById('stormStatus').textContent = data.stormStatus;

            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('th-TH');
            
            // You should add sensor data updates here as well (from another MQTT topic)
            // For now, keep the simulation running for sensor data
        }
        
        // ----------------------------------------------------
        // --- 5. SIMULATION AND TABLE FUNCTIONS (Kept from original) ---
        // ----------------------------------------------------

        // --- Original Simulation Function Modified to ONLY update Sensor Data (as weather is now real) ---
        function simulateRealTimeData() {
            // Update sensor displays
            document.getElementById('temperature').textContent = (20 + Math.random() * 15).toFixed(1) + '¬∞C';
            document.getElementById('humidity').textContent = (40 + Math.random() * 40).toFixed(0) + '%';
            document.getElementById('micLevel').textContent = (30 + Math.random() * 40).toFixed(0) + ' dB';
            
            // Simulate fire detection
            if (Math.random() > 0.95) {
                document.getElementById('fireStatus').textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÑ‡∏ü!';
                document.getElementById('fireIndicator').className = 'status-indicator status-danger pulse';
            } else {
                document.getElementById('fireStatus').textContent = '‡∏õ‡∏Å‡∏ï‡∏¥';
                document.getElementById('fireIndicator').className = 'status-indicator status-normal pulse';
            }
            
            // Simulate door knock
            if (Math.random() > 0.9) {
                document.getElementById('doorKnock').textContent = '‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏≤‡∏∞';
                document.getElementById('doorIndicator').className = 'status-indicator status-warning';
            } else {
                document.getElementById('doorKnock').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                document.getElementById('doorIndicator').className = 'status-indicator status-normal';
            }

            // Note: Weather data update part removed here as it's handled by MQTT now.

            // Add new data to table
            const newData = {
                timestamp: new Date().toLocaleString('th-TH'),
                temperature: document.getElementById('temperature').textContent.replace('¬∞C', ''),
                humidity: document.getElementById('humidity').textContent.replace('%', ''),
                sound: document.getElementById('micLevel').textContent.replace(' dB', ''),
                fire: document.getElementById('fireStatus').textContent,
                door: document.getElementById('doorKnock').textContent,
                status: Math.random() > 0.1 ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'
            };
            
            sensorData.unshift(newData);
            if (sensorData.length > 100) sensorData.pop(); 
            
            updateTable();
        }
        
        // (updateTable, initializeData, nextPage, prevPage, refreshData, exportData functions remain the same)
        function initializeData() {
            // ... (original initializeData function)
        }
        function updateTable() {
            // ... (original updateTable function)
        }
        function nextPage() {
            // ... (original nextPage function)
        }
        function prevPage() {
            // ... (original prevPage function)
        }
        function refreshData() {
            // ... (original refreshData function)
            // Note: This now only refreshes sensor data simulation and table.
        }
        function exportData() {
            // ... (original exportData function)
        }


        // --- 6. INITIALIZATION ---
        initializeData();
        // Starts the MQTT connection to receive API data
        connectMQTT();
        
        // Keep the sensor simulation running every 5 seconds
        setInterval(simulateRealTimeData, 5000); 
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9918fde2534f8940',t:'MTc2MDk2ODMwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
